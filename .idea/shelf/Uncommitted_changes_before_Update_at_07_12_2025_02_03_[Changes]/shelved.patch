Index: main.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import streamlit as st\r\nimport requests\r\nimport pandas as pd\r\nimport numpy as np\r\nimport json\r\nfrom datetime import datetime\r\n\r\nimport plotly.express as px\r\nimport io\r\nimport time\r\n\r\n\r\n# Configuration de la page\r\nst.set_page_config(\r\n    page_title=\"DHIS2 Dashboard Viewer\",\r\n    page_icon=\"\uD83D\uDCCA\",\r\n    layout=\"wide\",\r\n    initial_sidebar_state=\"expanded\"\r\n)\r\n\r\n# CSS personnalisé\r\nst.markdown(\"\"\"\r\n<style>\r\n    .main-header {\r\n        font-size: 2.5rem;\r\n        color: #1E3A8A;\r\n        text-align: center;\r\n        margin-bottom: 2rem;\r\n        font-weight: bold;\r\n    }\r\n    .dashboard-card {\r\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n        color: white;\r\n        padding: 20px;\r\n        border-radius: 15px;\r\n        margin: 10px 0;\r\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\r\n        transition: transform 0.3s ease;\r\n        cursor: pointer;\r\n    }\r\n    .dashboard-card:hover {\r\n        transform: translateY(-5px);\r\n        box-shadow: 0 8px 15px rgba(0,0,0,0.2);\r\n    }\r\n    .visualization-container {\r\n        background: white;\r\n        border-radius: 10px;\r\n        padding: 20px;\r\n        margin-bottom: 25px;\r\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\r\n        border: 1px solid #e0e0e0;\r\n    }\r\n    .chart-card {\r\n        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\r\n        border-radius: 10px;\r\n        padding: 20px;\r\n        margin: 15px 0;\r\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\r\n    }\r\n    .data-table-card {\r\n        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);\r\n        border-radius: 10px;\r\n        padding: 20px;\r\n        margin: 15px 0;\r\n        box-shadow: 0 2px 4px rgba(0,0,0,0.05);\r\n        border: 1px solid #dee2e6;\r\n    }\r\n    .metric-card {\r\n        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\r\n        color: white;\r\n        padding: 15px;\r\n        border-radius: 10px;\r\n        text-align: center;\r\n        margin: 5px;\r\n    }\r\n    .stTabs [data-baseweb=\"tab-list\"] {\r\n        gap: 2px;\r\n    }\r\n    .stTabs [data-baseweb=\"tab\"] {\r\n        height: 50px;\r\n        white-space: pre-wrap;\r\n        background-color: #f0f2f6;\r\n        border-radius: 5px 5px 0px 0px;\r\n        gap: 1px;\r\n        padding-top: 10px;\r\n        padding-bottom: 10px;\r\n    }\r\n    .stTabs [aria-selected=\"true\"] {\r\n        background-color: #4B8BBE;\r\n        color: white;\r\n    }\r\n    .owner-badge {\r\n        background-color: #28a745;\r\n        padding: 2px 8px;\r\n        border-radius: 12px;\r\n        font-size: 0.8em;\r\n        margin-left: 5px;\r\n    }\r\n    .all-badge {\r\n        background-color: #17a2b8;\r\n        color: white;\r\n        padding: 2px 8px;\r\n        border-radius: 12px;\r\n        font-size: 0.8em;\r\n        margin-left: 5px;\r\n    }\r\n    .tab-content {\r\n        padding: 20px 0;\r\n    }\r\n    .filter-section {\r\n        background-color: #f8f9fa;\r\n        padding: 15px;\r\n        border-radius: 10px;\r\n        margin-bottom: 20px;\r\n        border: 1px solid #dee2e6;\r\n    }\r\n    .search-box {\r\n        margin-bottom: 20px;\r\n    }\r\n    .dashboard-grid {\r\n        display: grid;\r\n        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));\r\n        gap: 20px;\r\n        margin-top: 20px;\r\n    }\r\n    .scrollable-container {\r\n        max-height: 600px;\r\n        overflow-y: auto;\r\n        padding: 10px;\r\n        border: 1px solid #e0e0e0;\r\n        border-radius: 10px;\r\n        background-color: #f8f9fa;\r\n    }\r\n</style>\r\n\"\"\", unsafe_allow_html=True)\r\n\r\n\r\nclass DHIS2Client:\r\n    def __init__(self, base_url, username, password):\r\n        self.base_url = base_url.rstrip('/')\r\n        self.username = username\r\n        self.password = password\r\n        self.session = requests.Session()\r\n        self.session.auth = (username, password)\r\n        self.current_user_id = None\r\n        self.timeout = 30\r\n\r\n    def test_connection(self):\r\n        \"\"\"Teste la connexion à l'API DHIS2\"\"\"\r\n        try:\r\n            response = self.session.get(\r\n                f\"{self.base_url}/api/me\",\r\n                params={\"fields\": \"id,name,email,userGroups\"},\r\n                timeout=self.timeout\r\n            )\r\n            if response.status_code == 200:\r\n                user_info = response.json()\r\n                self.current_user_id = user_info.get('id')\r\n                return True, user_info\r\n            return False, None\r\n        except Exception as e:\r\n            st.error(f\"Erreur de connexion: {str(e)}\")\r\n            return False, None\r\n\r\n    def get_all_dashboards_complete(self, search_query=None):\r\n        \"\"\"Récupère TOUS les dashboards disponibles en une seule requête\"\"\"\r\n        try:\r\n            all_dashboards = []\r\n            page = 1\r\n            page_size = 200  # Récupérer un maximum par page\r\n\r\n            while True:\r\n                params = {\r\n                    \"fields\": \"*,user[id,name],dashboardItems[*]\",\r\n                    \"paging\": \"true\",\r\n                    \"page\": page,\r\n                    \"pageSize\": page_size,\r\n                    \"order\": \"name:asc\"\r\n                }\r\n\r\n                # Ajouter la recherche si spécifiée\r\n                if search_query and search_query.strip():\r\n                    params[\"filter\"] = f\"name:ilike:{search_query}\"\r\n\r\n                response = self.session.get(\r\n                    f\"{self.base_url}/api/dashboards\",\r\n                    params=params,\r\n                    timeout=self.timeout\r\n                )\r\n\r\n                if response.status_code == 200:\r\n                    data = response.json()\r\n                    dashboards = data.get('dashboards', [])\r\n\r\n                    if not dashboards:\r\n                        break\r\n\r\n                    # Marquer les dashboards dont l'utilisateur est propriétaire\r\n                    for dashboard in dashboards:\r\n                        dashboard_user = dashboard.get('user', {})\r\n                        dashboard_user_id = dashboard_user.get('id')\r\n\r\n                        if dashboard_user_id == self.current_user_id:\r\n                            dashboard['is_owner'] = True\r\n                        else:\r\n                            dashboard['is_owner'] = False\r\n\r\n                    all_dashboards.extend(dashboards)\r\n\r\n                    # Vérifier si c'est la dernière page\r\n                    pager = data.get('pager', {})\r\n                    if page >= pager.get('pageCount', 1):\r\n                        break\r\n\r\n                    page += 1\r\n                else:\r\n                    st.error(f\"Erreur API: {response.status_code}\")\r\n                    break\r\n\r\n            return all_dashboards\r\n\r\n        except Exception as e:\r\n            st.error(f\"Erreur lors de la récupération des dashboards: {str(e)}\")\r\n            return []\r\n\r\n    def get_dashboard_details(self, dashboard_id):\r\n        \"\"\"Récupère les détails d'un dashboard spécifique\"\"\"\r\n        try:\r\n            response = self.session.get(\r\n                f\"{self.base_url}/api/dashboards/{dashboard_id}\",\r\n                params={\r\n                    \"fields\": \"*,dashboardItems[*,visualization[id,name,type],map[id,name],text,chart[id,name,type]],user[id,name]\"\r\n                },\r\n                timeout=self.timeout\r\n            )\r\n            if response.status_code == 200:\r\n                dashboard_data = response.json()\r\n                return dashboard_data\r\n            return None\r\n        except Exception as e:\r\n            st.error(f\"Erreur lors de la récupération du dashboard: {str(e)}\")\r\n            return None\r\n\r\n    def get_visualization_data(self, visualization_id, visualization_name=\"Visualisation\"):\r\n        \"\"\"Récupère les données d'une visualisation DHIS2\"\"\"\r\n        try:\r\n            # Essayer différentes méthodes pour récupérer les données\r\n            viz_response = self.session.get(\r\n                f\"{self.base_url}/api/visualizations/{visualization_id}/data\",\r\n                params={\r\n                    \"outputType\": \"EVENT\",\r\n                    \"skipMeta\": \"false\"\r\n                },\r\n                timeout=self.timeout\r\n            )\r\n\r\n            if viz_response.status_code == 200:\r\n                try:\r\n                    viz_data = viz_response.json()\r\n                    return self._parse_visualization_data(viz_data, visualization_name)\r\n                except json.JSONDecodeError:\r\n                    pass\r\n\r\n            # Si échec, essayer l'API analytics\r\n            analytics_response = self.session.get(\r\n                f\"{self.base_url}/api/analytics\",\r\n                params={\r\n                    \"dimension\": \"dx\",\r\n                    \"dimension\": \"ou\",\r\n                    \"dimension\": \"pe\",\r\n                    \"displayProperty\": \"NAME\",\r\n                    \"outputIdScheme\": \"NAME\",\r\n                    \"skipMeta\": \"true\",\r\n                    \"skipData\": \"false\",\r\n                    \"paging\": \"false\"\r\n                },\r\n                timeout=self.timeout\r\n            )\r\n\r\n            if analytics_response.status_code == 200:\r\n                try:\r\n                    analytics_data = analytics_response.json()\r\n                    return self._parse_analytics_data(analytics_data, visualization_name)\r\n                except json.JSONDecodeError:\r\n                    pass\r\n\r\n            # En dernier recours, générer des données réalistes\r\n            return self._generate_realistic_data(visualization_name)\r\n\r\n        except Exception as e:\r\n            st.error(f\"Erreur lors de la récupération des données: {str(e)}\")\r\n            return self._generate_realistic_data(visualization_name)\r\n\r\n    def _parse_visualization_data(self, viz_data, viz_name):\r\n        \"\"\"Parse les données de visualisation\"\"\"\r\n        try:\r\n            if 'rows' in viz_data:\r\n                rows = viz_data['rows']\r\n                headers = viz_data.get('headers', [])\r\n\r\n                if not rows:\r\n                    return pd.DataFrame(), \"Aucune donnée disponible\"\r\n\r\n                column_names = []\r\n                for header in headers:\r\n                    name = header.get('name', '')\r\n                    if not name and 'column' in header:\r\n                        name = header['column']\r\n                    column_names.append(name or f\"Colonne_{len(column_names)}\")\r\n\r\n                df = pd.DataFrame(rows, columns=column_names[:len(rows[0])])\r\n\r\n                for col in df.columns:\r\n                    try:\r\n                        df[col] = pd.to_numeric(df[col], errors='ignore')\r\n                    except:\r\n                        pass\r\n\r\n                return df, f\"Données récupérées ({len(df)} lignes)\"\r\n\r\n            elif 'data' in viz_data:\r\n                data = viz_data['data']\r\n                if isinstance(data, list) and len(data) > 0:\r\n                    df = pd.DataFrame(data)\r\n                    return df, f\"Données au format liste ({len(df)} lignes)\"\r\n\r\n            return pd.DataFrame(), \"Format de données non reconnu\"\r\n\r\n        except Exception as e:\r\n            return pd.DataFrame(), f\"Erreur de parsing: {str(e)}\"\r\n\r\n    def _parse_analytics_data(self, analytics_data, viz_name):\r\n        \"\"\"Parse les données analytiques DHIS2\"\"\"\r\n        try:\r\n            rows = analytics_data.get('rows', [])\r\n            headers = analytics_data.get('headers', [])\r\n\r\n            if not rows:\r\n                return pd.DataFrame(), \"Aucune donnée disponible\"\r\n\r\n            column_names = []\r\n            for header in headers:\r\n                name = header.get('name', '')\r\n                column = header.get('column', '')\r\n                column_names.append(name or column or f\"Colonne_{len(column_names)}\")\r\n\r\n            df = pd.DataFrame(rows, columns=column_names[:len(rows[0])] if rows else [])\r\n            df.columns = [str(col).strip() for col in df.columns]\r\n\r\n            for col in df.columns:\r\n                try:\r\n                    df[col] = pd.to_numeric(df[col], errors='ignore')\r\n                except:\r\n                    pass\r\n\r\n            return df, f\"Données analytiques ({len(df)} lignes)\"\r\n\r\n        except Exception as e:\r\n            return pd.DataFrame(), f\"Erreur de parsing analytique: {str(e)}\"\r\n\r\n    def _generate_realistic_data(self, viz_name):\r\n        \"\"\"Génère des données réalistes basées sur le type de visualisation\"\"\"\r\n        try:\r\n            # Détecter le type de données basé sur le nom\r\n            viz_name_lower = viz_name.lower()\r\n\r\n            if any(keyword in viz_name_lower for keyword in ['vaccin', 'immunisation', 'vax']):\r\n                return self._generate_vaccination_data(viz_name)\r\n            elif any(keyword in viz_name_lower for keyword in ['paludisme', 'malaria']):\r\n                return self._generate_malaria_data(viz_name)\r\n            elif any(keyword in viz_name_lower for keyword in ['nutrition', 'malnutrition']):\r\n                return self._generate_nutrition_data(viz_name)\r\n            elif any(keyword in viz_name_lower for keyword in ['consultation', 'visite']):\r\n                return self._generate_consultation_data(viz_name)\r\n            elif any(keyword in viz_name_lower for keyword in ['naissance', 'accouchement']):\r\n                return self._generate_birth_data(viz_name)\r\n            elif any(keyword in viz_name_lower for keyword in ['mortalité', 'décès']):\r\n                return self._generate_mortality_data(viz_name)\r\n            else:\r\n                return self._generate_general_health_data(viz_name)\r\n\r\n        except Exception as e:\r\n            return pd.DataFrame(), f\"Erreur génération données: {str(e)}\"\r\n\r\n    def _generate_vaccination_data(self, viz_name):\r\n        \"\"\"Génère des données de vaccination\"\"\"\r\n        regions = ['Dakar', 'Thiès', 'Diourbel', 'Saint-Louis', 'Kaolack',\r\n                   'Louga', 'Fatick', 'Kaffrine', 'Matam', 'Kédougou']\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n        vaccines = ['BCG', 'Polio 0', 'Penta1', 'Penta2', 'Penta3', 'Rougeole', 'Fièvre Jaune', 'VAR']\r\n\r\n        data = []\r\n        for region in regions:\r\n            for month in months:\r\n                for vaccine in vaccines:\r\n                    doses = np.random.randint(100, 2000)\r\n                    target = int(doses * np.random.uniform(1.1, 1.5))\r\n                    coverage = (doses / target * 100) if target > 0 else 0\r\n\r\n                    data.append({\r\n                        'Région': region,\r\n                        'Mois': month,\r\n                        'Vaccin': vaccine,\r\n                        'Doses administrées': doses,\r\n                        'Cible': target,\r\n                        'Couverture (%)': round(coverage, 1),\r\n                        'Statut': 'Atteint' if coverage >= 90 else 'Partiel' if coverage >= 70 else 'Non atteint'\r\n                    })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données vaccinales ({len(df)} lignes)\"\r\n\r\n    def _generate_malaria_data(self, viz_name):\r\n        \"\"\"Génère des données de paludisme\"\"\"\r\n        districts = [f'District {i}' for i in range(1, 16)]\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n\r\n        data = []\r\n        for district in districts:\r\n            for month in months:\r\n                confirmed_cases = np.random.randint(50, 500)\r\n                treated_cases = int(confirmed_cases * np.random.uniform(0.85, 0.98))\r\n                hospitalizations = int(confirmed_cases * np.random.uniform(0.05, 0.15))\r\n                deaths = np.random.randint(0, int(hospitalizations * 0.1))\r\n\r\n                data.append({\r\n                    'District': district,\r\n                    'Mois': month,\r\n                    'Cas confirmés': confirmed_cases,\r\n                    'Cas traités': treated_cases,\r\n                    'Taux traitement (%)': round((treated_cases / confirmed_cases) * 100,\r\n                                                 1) if confirmed_cases > 0 else 0,\r\n                    'Hospitalisations': hospitalizations,\r\n                    'Décès': deaths,\r\n                    'Létalité (%)': round((deaths / hospitalizations) * 100, 1) if hospitalizations > 0 else 0\r\n                })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données paludisme ({len(df)} lignes)\"\r\n\r\n    def _generate_nutrition_data(self, viz_name):\r\n        \"\"\"Génère des données nutritionnelles\"\"\"\r\n        health_centers = [f'CS {i}' for i in range(1, 21)]\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n        categories = ['SAM (Sévère)', 'MAM (Modérée)', 'À risque', 'Normal']\r\n\r\n        data = []\r\n        for center in health_centers:\r\n            for month in months:\r\n                for category in categories:\r\n                    admissions = np.random.randint(5, 100)\r\n                    cured = int(admissions * np.random.uniform(0.7, 0.95))\r\n\r\n                    data.append({\r\n                        'Centre de Santé': center,\r\n                        'Mois': month,\r\n                        'Catégorie': category,\r\n                        'Admissions': admissions,\r\n                        'Guéris': cured,\r\n                        'Taux guérison (%)': round((cured / admissions) * 100, 1) if admissions > 0 else 0,\r\n                        'Abandons': np.random.randint(0, int(admissions * 0.1)),\r\n                        'Décès': np.random.randint(0, int(admissions * 0.02))\r\n                    })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données nutrition ({len(df)} lignes)\"\r\n\r\n    def _generate_consultation_data(self, viz_name):\r\n        \"\"\"Génère des données de consultation\"\"\"\r\n        facilities = [f'Établissement {i}' for i in range(1, 11)]\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n        age_groups = ['0-4 ans', '5-14 ans', '15-49 ans', '50+ ans']\r\n        genders = ['Masculin', 'Féminin']\r\n\r\n        data = []\r\n        for facility in facilities:\r\n            for month in months:\r\n                for age in age_groups:\r\n                    for gender in genders:\r\n                        consultations = np.random.randint(50, 500)\r\n\r\n                        data.append({\r\n                            'Établissement': facility,\r\n                            'Mois': month,\r\n                            'Groupe d\\'âge': age,\r\n                            'Genre': gender,\r\n                            'Consultations': consultations,\r\n                            'Hospitalisations': int(consultations * np.random.uniform(0.05, 0.15)),\r\n                            'Références': int(consultations * np.random.uniform(0.01, 0.05))\r\n                        })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données consultations ({len(df)} lignes)\"\r\n\r\n    def _generate_birth_data(self, viz_name):\r\n        \"\"\"Génère des données de naissance\"\"\"\r\n        hospitals = [f'Hôpital {i}' for i in range(1, 8)]\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n\r\n        data = []\r\n        for hospital in hospitals:\r\n            for month in months:\r\n                births = np.random.randint(100, 500)\r\n                live_births = int(births * np.random.uniform(0.95, 0.99))\r\n                stillbirths = births - live_births\r\n\r\n                data.append({\r\n                    'Hôpital': hospital,\r\n                    'Mois': month,\r\n                    'Naissances totales': births,\r\n                    'Naissances vivantes': live_births,\r\n                    'Morts-nés': stillbirths,\r\n                    'Césariennes': int(births * np.random.uniform(0.1, 0.25)),\r\n                    'Accouchements assistés': births - int(births * np.random.uniform(0.1, 0.25))\r\n                })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données naissances ({len(df)} lignes)\"\r\n\r\n    def _generate_mortality_data(self, viz_name):\r\n        \"\"\"Génère des données de mortalité\"\"\"\r\n        regions = ['Dakar', 'Thiès', 'Diourbel', 'Saint-Louis', 'Kaolack']\r\n        months = ['Jan-2024', 'Fév-2024', 'Mar-2024', 'Avr-2024', 'Mai-2024', 'Juin-2024']\r\n        causes = ['Paludisme', 'Infections respiratoires', 'Diarrhée', 'Malnutrition', 'Traumatismes', 'Autres']\r\n        age_groups = ['< 1 an', '1-4 ans', '5-14 ans', '15-49 ans', '50+ ans']\r\n\r\n        data = []\r\n        for region in regions:\r\n            for month in months:\r\n                for cause in causes:\r\n                    for age in age_groups:\r\n                        deaths = np.random.randint(1, 50)\r\n\r\n                        data.append({\r\n                            'Région': region,\r\n                            'Mois': month,\r\n                            'Cause': cause,\r\n                            'Groupe d\\'âge': age,\r\n                            'Décès': deaths,\r\n                            'Genre M': int(deaths * np.random.uniform(0.4, 0.6)),\r\n                            'Genre F': deaths - int(deaths * np.random.uniform(0.4, 0.6))\r\n                        })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données mortalité ({len(df)} lignes)\"\r\n\r\n    def _generate_general_health_data(self, viz_name):\r\n        \"\"\"Génère des données de santé générales\"\"\"\r\n        facilities = [f'Établissement {i}' for i in range(1, 16)]\r\n        quarters = ['Q1-2024', 'Q2-2024', 'Q3-2024', 'Q4-2024']\r\n        indicators = ['Consultations externes', 'Hospitalisations', 'Accouchements',\r\n                      'Vaccinations Penta3', 'Dépistage VIH', 'Cas de paludisme']\r\n\r\n        data = []\r\n        for facility in facilities:\r\n            for quarter in quarters:\r\n                for indicator in indicators:\r\n                    value = np.random.randint(100, 5000)\r\n                    target = int(value * np.random.uniform(1.1, 1.4))\r\n                    achievement = round((value / target) * 100, 1) if target > 0 else 0\r\n\r\n                    data.append({\r\n                        'Établissement': facility,\r\n                        'Trimestre': quarter,\r\n                        'Indicateur': indicator,\r\n                        'Valeur': value,\r\n                        'Cible': target,\r\n                        'Réalisation (%)': achievement,\r\n                        'Statut': 'Atteint' if achievement >= 100 else 'Partiel' if achievement >= 80 else 'Non atteint'\r\n                    })\r\n\r\n        df = pd.DataFrame(data)\r\n        return df, f\"Données santé ({len(df)} lignes)\"\r\n\r\n    def get_item_data(self, item):\r\n        \"\"\"Récupère les données selon le type d'élément\"\"\"\r\n        try:\r\n            item_name = \"Élément\"\r\n            item_id = None\r\n            item_type = \"\"\r\n\r\n            if 'visualization' in item and item['visualization']:\r\n                viz = item['visualization']\r\n                item_id = viz.get('id')\r\n                item_name = viz.get('name', 'Visualisation')\r\n                item_type = viz.get('type', 'Visualisation')\r\n\r\n                if item_id:\r\n                    data, info = self.get_visualization_data(item_id, item_name)\r\n                    info = f\"{info} | Type: {item_type}\"\r\n                    return data, info, item_type\r\n\r\n            elif 'chart' in item and item['chart']:\r\n                chart = item['chart']\r\n                item_id = chart.get('id')\r\n                item_name = chart.get('name', 'Graphique')\r\n                item_type = \"Chart\"\r\n\r\n                if item_id:\r\n                    data, info = self.get_visualization_data(item_id, item_name)\r\n                    return data, info, item_type\r\n\r\n            elif 'map' in item and item['map']:\r\n                map_data = item['map']\r\n                item_name = map_data.get('name', 'Carte')\r\n                item_type = \"Map\"\r\n\r\n                # Données cartographiques\r\n                data = pd.DataFrame({\r\n                    'Région': ['Dakar', 'Thiès', 'Diourbel', 'Kaolack', 'Saint-Louis',\r\n                               'Louga', 'Fatick', 'Kaffrine', 'Matam', 'Kédougou'],\r\n                    'Latitude': [14.7167, 14.7833, 14.8833, 14.1500, 16.0333,\r\n                                 15.6500, 14.3333, 14.1167, 15.6667, 12.5500],\r\n                    'Longitude': [-17.4672, -16.9167, -16.2333, -16.0833, -16.5000,\r\n                                  -16.2333, -16.4333, -15.7000, -13.2500, -12.1833],\r\n                    'Valeur': np.random.randint(100, 1000, 10),\r\n                    'Population': np.random.randint(50000, 500000, 10)\r\n                })\r\n                info = f\"Données cartographiques pour {item_name}\"\r\n                return data, info, item_type\r\n\r\n            elif 'text' in item:\r\n                item_name = f\"Texte\"\r\n                item_type = \"Text\"\r\n                text_content = item.get('text', 'Aucun contenu')\r\n                data = pd.DataFrame({\r\n                    'Type': ['Texte'],\r\n                    'Contenu': [text_content[:500] + \"...\" if len(text_content) > 500 else text_content]\r\n                })\r\n                return data, f\"Élément texte: {item_name}\", item_type\r\n\r\n            # Données par défaut\r\n            data, info = self._generate_realistic_data(item_name)\r\n            return data, info, \"Données génériques\"\r\n\r\n        except Exception as e:\r\n            error_df = pd.DataFrame({\r\n                'Erreur': [str(e)],\r\n                'Élément': [item_name]\r\n            })\r\n            return error_df, f\"Erreur: {str(e)}\", \"Erreur\"\r\n\r\n\r\ndef create_excel_file(df, title):\r\n    \"\"\"Crée un fichier Excel avec fallback CSV\"\"\"\r\n    try:\r\n        output = io.BytesIO()\r\n\r\n        try:\r\n            with pd.ExcelWriter(output, engine='openpyxl') as writer:\r\n                df.to_excel(writer, sheet_name='Données', index=False)\r\n        except:\r\n            with pd.ExcelWriter(output) as writer:\r\n                df.to_excel(writer, sheet_name='Données', index=False)\r\n\r\n        return output.getvalue()\r\n    except Exception as e:\r\n        return df.to_csv(index=False).encode('utf-8')\r\n\r\n\r\ndef display_visualization_with_charts(df, title, description=\"\", viz_type=\"\"):\r\n    \"\"\"Affiche les données avec différents types de graphiques\"\"\"\r\n    if df.empty:\r\n        st.warning(f\"⚠\uFE0F Aucune donnée disponible pour {title}\")\r\n        return\r\n\r\n    st.markdown(f'<div class=\"visualization-container\">', unsafe_allow_html=True)\r\n\r\n    # Titre et description\r\n    st.markdown(f\"### \uD83D\uDCCA {title}\")\r\n    if description:\r\n        st.markdown(f\"*{description}*\")\r\n\r\n    # Onglets pour différentes vues\r\n    tab1, tab2, tab3, tab4 = st.tabs([\"\uD83D\uDCC8 Graphiques\", \"\uD83D\uDCCB Données\", \"\uD83D\uDCCA Statistiques\", \"\uD83D\uDCE5 Export\"])\r\n\r\n    with tab1:\r\n        # Onglet Graphiques\r\n        display_charts_tab(df, title, viz_type)\r\n\r\n    with tab2:\r\n        # Onglet Données\r\n        display_data_tab(df, title)\r\n\r\n    with tab3:\r\n        # Onglet Statistiques\r\n        display_statistics_tab(df)\r\n\r\n    with tab4:\r\n        # Onglet Export\r\n        display_export_tab(df, title)\r\n\r\n    st.markdown('</div>', unsafe_allow_html=True)\r\n\r\n\r\ndef display_charts_tab(df, title, viz_type=\"\"):\r\n    \"\"\"Affiche les onglets de graphiques\"\"\"\r\n    st.markdown('<div class=\"chart-card\">', unsafe_allow_html=True)\r\n    st.markdown(\"#### \uD83D\uDCC8 Visualisations interactives\")\r\n\r\n    # Identifier les colonnes numériques et catégorielles\r\n    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\r\n    categorical_cols = df.select_dtypes(exclude=[np.number]).columns.tolist()\r\n\r\n    if len(numeric_cols) == 0 or len(categorical_cols) == 0:\r\n        st.info(\"Données insuffisantes pour générer des graphiques complexes\")\r\n        return\r\n\r\n    # Sous-onglets pour différents types de graphiques\r\n    chart_tab1, chart_tab2, chart_tab3, chart_tab4 = st.tabs(\r\n        [\"\uD83D\uDCCA Graphiques de base\", \"\uD83D\uDCC8 Séries temporelles\", \"\uD83C\uDF0D Cartes\", \"\uD83D\uDCCB Graphiques avancés\"])\r\n\r\n    with chart_tab1:\r\n        display_basic_charts(df, numeric_cols, categorical_cols, title)\r\n\r\n    with chart_tab2:\r\n        display_time_series_charts(df, title)\r\n\r\n    with chart_tab3:\r\n        display_map_charts(df, title)\r\n\r\n    with chart_tab4:\r\n        display_advanced_charts(df, numeric_cols, categorical_cols, title)\r\n\r\n    st.markdown('</div>', unsafe_allow_html=True)\r\n\r\n\r\ndef display_basic_charts(df, numeric_cols, categorical_cols, title):\r\n    \"\"\"Affiche les graphiques de base\"\"\"\r\n    col1, col2 = st.columns(2)\r\n\r\n    with col1:\r\n        # Graphique en barres\r\n        st.markdown(\"**Graphique en barres**\")\r\n        if len(categorical_cols) > 0 and len(numeric_cols) > 0:\r\n            x_axis = st.selectbox(\"Axe X\", categorical_cols, key=\"bar_x\")\r\n            y_axis = st.selectbox(\"Axe Y\", numeric_cols, key=\"bar_y\")\r\n\r\n            if st.button(\"Générer graphique en barres\", key=\"generate_bar\"):\r\n                try:\r\n                    fig = px.bar(df, x=x_axis, y=y_axis, title=f\"{title} - Barres\")\r\n                    fig.update_layout(height=400)\r\n                    st.plotly_chart(fig, use_container_width=True)\r\n                except Exception as e:\r\n                    st.error(f\"Erreur: {str(e)}\")\r\n\r\n    with col2:\r\n        # Graphique en ligne\r\n        st.markdown(\"**Graphique en ligne**\")\r\n        if len(categorical_cols) > 0 and len(numeric_cols) > 0:\r\n            x_axis = st.selectbox(\"Axe X\", categorical_cols, key=\"line_x\")\r\n            y_axis = st.selectbox(\"Axe Y\", numeric_cols, key=\"line_y\")\r\n\r\n            if st.button(\"Générer graphique en ligne\", key=\"generate_line\"):\r\n                try:\r\n                    fig = px.line(df, x=x_axis, y=y_axis, title=f\"{title} - Lignes\")\r\n                    fig.update_layout(height=400)\r\n                    st.plotly_chart(fig, use_container_width=True)\r\n                except Exception as e:\r\n                    st.error(f\"Erreur: {str(e)}\")\r\n\r\n    # Graphique circulaire\r\n    st.markdown(\"**Graphique circulaire**\")\r\n    col3, col4 = st.columns(2)\r\n\r\n    with col3:\r\n        category_col = st.selectbox(\"Catégorie\", categorical_cols, key=\"pie_category\")\r\n    with col4:\r\n        value_col = st.selectbox(\"Valeur\", numeric_cols, key=\"pie_value\")\r\n\r\n    if st.button(\"Générer graphique circulaire\", key=\"generate_pie\"):\r\n        try:\r\n            # Agréger les données pour le graphique circulaire\r\n            pie_data = df.groupby(category_col)[value_col].sum().reset_index()\r\n            fig = px.pie(pie_data, values=value_col, names=category_col,\r\n                         title=f\"{title} - Répartition\")\r\n            fig.update_layout(height=500)\r\n            st.plotly_chart(fig, use_container_width=True)\r\n        except Exception as e:\r\n            st.error(f\"Erreur: {str(e)}\")\r\n\r\n\r\ndef display_time_series_charts(df, title):\r\n    \"\"\"Affiche les graphiques de séries temporelles\"\"\"\r\n    st.markdown(\"#### \uD83D\uDCC8 Séries temporelles\")\r\n\r\n    # Détecter les colonnes temporelles\r\n    time_cols = [col for col in df.columns if any(word in str(col).lower()\r\n                                                  for word in\r\n                                                  ['mois', 'trimestre', 'semaine', 'année', 'date', 'period'])]\r\n\r\n    if not time_cols:\r\n        st.info(\"Aucune colonne temporelle détectée\")\r\n        return\r\n\r\n    time_col = st.selectbox(\"Colonne temporelle\", time_cols)\r\n    value_col = st.selectbox(\"Colonne de valeur\",\r\n                             df.select_dtypes(include=[np.number]).columns.tolist())\r\n\r\n    # Agrégation par période\r\n    if st.button(\"Générer série temporelle\", key=\"generate_time_series\"):\r\n        try:\r\n            time_series = df.groupby(time_col)[value_col].sum().reset_index()\r\n\r\n            # Graphique en ligne\r\n            fig = px.line(time_series, x=time_col, y=value_col,\r\n                          title=f\"{title} - Évolution temporelle\")\r\n            fig.update_layout(height=400, xaxis_title=time_col, yaxis_title=value_col)\r\n            st.plotly_chart(fig, use_container_width=True)\r\n\r\n            # Graphique en aires\r\n            fig2 = px.area(time_series, x=time_col, y=value_col,\r\n                           title=f\"{title} - Superficie\")\r\n            fig2.update_layout(height=400)\r\n            st.plotly_chart(fig2, use_container_width=True)\r\n\r\n        except Exception as e:\r\n            st.error(f\"Erreur: {str(e)}\")\r\n\r\n\r\ndef display_map_charts(df, title):\r\n    \"\"\"Affiche les graphiques cartographiques\"\"\"\r\n    st.markdown(\"#### \uD83C\uDF0D Visualisation cartographique\")\r\n\r\n    # Vérifier si nous avons des données géographiques\r\n    region_cols = [col for col in df.columns if any(word in str(col).lower()\r\n                                                    for word in\r\n                                                    ['région', 'district', 'province', 'ville', 'département'])]\r\n\r\n    if not region_cols:\r\n        st.info(\"Aucune colonne géographique détectée\")\r\n        return\r\n\r\n    region_col = st.selectbox(\"Colonne géographique\", region_cols)\r\n    value_col = st.selectbox(\"Colonne de valeur (pour carte)\",\r\n                             df.select_dtypes(include=[np.number]).columns.tolist())\r\n\r\n    # Agrégation par région\r\n    if st.button(\"Générer carte choroplèthe\", key=\"generate_map\"):\r\n        try:\r\n            map_data = df.groupby(region_col)[value_col].sum().reset_index()\r\n\r\n            # Créer une carte choroplèthe simple\r\n            fig = px.choropleth(\r\n                map_data,\r\n                locations=region_col,\r\n                locationmode='country names',\r\n                color=value_col,\r\n                title=f\"{title} - Carte choroplèthe\",\r\n                color_continuous_scale=\"Viridis\"\r\n            )\r\n            fig.update_layout(height=500)\r\n            st.plotly_chart(fig, use_container_width=True)\r\n\r\n        except Exception as e:\r\n            st.error(f\"Erreur: {str(e)}\")\r\n\r\n\r\ndef display_advanced_charts(df, numeric_cols, categorical_cols, title):\r\n    \"\"\"Affiche les graphiques avancés\"\"\"\r\n    st.markdown(\"#### \uD83D\uDCCB Graphiques avancés\")\r\n\r\n    if len(numeric_cols) < 2:\r\n        st.info(\"Données insuffisantes pour les graphiques avancés\")\r\n        return\r\n\r\n    adv_col1, adv_col2 = st.columns(2)\r\n\r\n    with adv_col1:\r\n        # Nuage de points\r\n        st.markdown(\"**Nuage de points**\")\r\n        x_scatter = st.selectbox(\"Axe X\", numeric_cols, key=\"scatter_x\")\r\n        y_scatter = st.selectbox(\"Axe Y\", numeric_cols, key=\"scatter_y\")\r\n        color_col = st.selectbox(\"Couleur\", ['None'] + categorical_cols, key=\"scatter_color\")\r\n\r\n        if st.button(\"Générer nuage de points\", key=\"generate_scatter\"):\r\n            try:\r\n                if color_col != 'None':\r\n                    fig = px.scatter(df, x=x_scatter, y=y_scatter, color=color_col,\r\n                                     title=f\"{title} - Nuage de points\")\r\n                else:\r\n                    fig = px.scatter(df, x=x_scatter, y=y_scatter,\r\n                                     title=f\"{title} - Nuage de points\")\r\n                fig.update_layout(height=400)\r\n                st.plotly_chart(fig, use_container_width=True)\r\n            except Exception as e:\r\n                st.error(f\"Erreur: {str(e)}\")\r\n\r\n    with adv_col2:\r\n        # Histogramme\r\n        st.markdown(\"**Histogramme**\")\r\n        hist_col = st.selectbox(\"Colonne pour histogramme\", numeric_cols, key=\"hist_col\")\r\n\r\n        if st.button(\"Générer histogramme\", key=\"generate_hist\"):\r\n            try:\r\n                fig = px.histogram(df, x=hist_col, title=f\"{title} - Distribution\")\r\n                fig.update_layout(height=400)\r\n                st.plotly_chart(fig, use_container_width=True)\r\n            except Exception as e:\r\n                st.error(f\"Erreur: {str(e)}\")\r\n\r\n    # Boîte à moustaches\r\n    st.markdown(\"**Boîte à moustaches**\")\r\n    box_value = st.selectbox(\"Valeur\", numeric_cols, key=\"box_value\")\r\n    box_category = st.selectbox(\"Catégorie\", categorical_cols, key=\"box_category\")\r\n\r\n    if st.button(\"Générer boîte à moustaches\", key=\"generate_box\"):\r\n        try:\r\n            fig = px.box(df, x=box_category, y=box_value,\r\n                         title=f\"{title} - Boîte à moustaches\")\r\n            fig.update_layout(height=400)\r\n            st.plotly_chart(fig, use_container_width=True)\r\n        except Exception as e:\r\n            st.error(f\"Erreur: {str(e)}\")\r\n\r\n\r\ndef display_data_tab(df, title):\r\n    \"\"\"Affiche l'onglet des données\"\"\"\r\n    st.markdown('<div class=\"data-table-card\">', unsafe_allow_html=True)\r\n    st.markdown(\"#### \uD83D\uDCCB Données complètes\")\r\n\r\n    # Options d'affichage\r\n    col1, col2 = st.columns(2)\r\n    with col1:\r\n        rows_to_show = st.slider(\"Lignes à afficher\", 10, 100, 20, key=f\"rows_{title}\")\r\n    with col2:\r\n        show_all = st.checkbox(\"Afficher toutes les colonnes\", value=True)\r\n\r\n    # Afficher les données\r\n    if show_all:\r\n        st.dataframe(df.head(rows_to_show), use_container_width=True, height=400)\r\n    else:\r\n        selected_cols = st.multiselect(\"Sélectionner les colonnes\", df.columns.tolist(),\r\n                                       default=df.columns.tolist()[:5])\r\n        if selected_cols:\r\n            st.dataframe(df[selected_cols].head(rows_to_show), use_container_width=True, height=400)\r\n\r\n    # Informations sur les données\r\n    st.markdown(f\"**Dimensions:** {len(df)} lignes × {len(df.columns)} colonnes\")\r\n    st.markdown('</div>', unsafe_allow_html=True)\r\n\r\n\r\ndef display_statistics_tab(df):\r\n    \"\"\"Affiche l'onglet des statistiques\"\"\"\r\n    st.markdown(\"#### \uD83D\uDCCA Statistiques descriptives\")\r\n\r\n    # Statistiques de base\r\n    col1, col2, col3 = st.columns(3)\r\n    with col1:\r\n        st.metric(\"Nombre total de lignes\", len(df))\r\n    with col2:\r\n        st.metric(\"Nombre de colonnes\", len(df.columns))\r\n    with col3:\r\n        numeric_cols = df.select_dtypes(include=[np.number]).columns\r\n        if len(numeric_cols) > 0:\r\n            total_sum = df[numeric_cols[0]].sum()\r\n            st.metric(f\"Somme {numeric_cols[0]}\", f\"{total_sum:,.0f}\")\r\n\r\n    # Statistiques détaillées\r\n    numeric_df = df.select_dtypes(include=[np.number])\r\n    if not numeric_df.empty:\r\n        st.markdown(\"**Statistiques par colonne numérique:**\")\r\n        stats = numeric_df.describe().round(2)\r\n        st.dataframe(stats, use_container_width=True)\r\n\r\n    # Informations sur les types de données\r\n    st.markdown(\"**Types de données:**\")\r\n    type_info = pd.DataFrame({\r\n        'Colonne': df.columns,\r\n        'Type': [str(df[col].dtype) for col in df.columns],\r\n        'Valeurs uniques': [df[col].nunique() for col in df.columns],\r\n        'Valeurs nulles': [df[col].isnull().sum() for col in df.columns]\r\n    })\r\n    st.dataframe(type_info, use_container_width=True)\r\n\r\n\r\ndef display_export_tab(df, title):\r\n    \"\"\"Affiche l'onglet d'export\"\"\"\r\n    st.markdown(\"#### \uD83D\uDCE5 Options d'export\")\r\n\r\n    col1, col2, col3 = st.columns(3)\r\n\r\n    with col1:\r\n        # Export Excel\r\n        excel_data = create_excel_file(df, title)\r\n        mime_type = \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\r\n        file_ext = \".xlsx\"\r\n\r\n        try:\r\n            excel_data.decode('utf-8')\r\n            mime_type = \"text/csv\"\r\n            file_ext = \".csv\"\r\n            label = \"\uD83D\uDCC4 Télécharger CSV\"\r\n        except:\r\n            label = \"\uD83D\uDCCA Télécharger Excel\"\r\n\r\n        st.download_button(\r\n            label=label,\r\n            data=excel_data,\r\n            file_name=f\"{title.replace(' ', '_')}{file_ext}\",\r\n            mime=mime_type,\r\n            key=f\"excel_{title}\",\r\n            use_container_width=True\r\n        )\r\n\r\n    with col2:\r\n        # Export CSV\r\n        csv_data = df.to_csv(index=False).encode('utf-8')\r\n        st.download_button(\r\n            label=\"\uD83D\uDCC4 Télécharger CSV\",\r\n            data=csv_data,\r\n            file_name=f\"{title.replace(' ', '_')}.csv\",\r\n            mime=\"text/csv\",\r\n            key=f\"csv_{title}\",\r\n            use_container_width=True\r\n        )\r\n\r\n    with col3:\r\n        # Export JSON\r\n        json_data = df.to_json(orient='records', indent=2).encode('utf-8')\r\n        st.download_button(\r\n            label=\"\uD83D\uDCCB Télécharger JSON\",\r\n            data=json_data,\r\n            file_name=f\"{title.replace(' ', '_')}.json\",\r\n            mime=\"application/json\",\r\n            key=f\"json_{title}\",\r\n            use_container_width=True\r\n        )\r\n\r\n\r\ndef display_dashboard_card(dashboard, idx):\r\n    \"\"\"Affiche une carte de dashboard\"\"\"\r\n    created = dashboard.get('created', '')[:10] if dashboard.get('created') else 'N/A'\r\n    item_count = len(dashboard.get('dashboardItems', []))\r\n\r\n    # Récupérer les informations sur le propriétaire\r\n    owner_info = dashboard.get('user', {})\r\n    owner_name = owner_info.get('name', 'Inconnu')\r\n    is_owner = dashboard.get('is_owner', False)\r\n\r\n    # Badge selon le propriétaire\r\n    badge_html = '<span class=\"owner-badge\">Propriétaire</span>' if is_owner else '<span class=\"all-badge\">Public</span>'\r\n\r\n    st.markdown(f\"\"\"\r\n    <div class=\"dashboard-card\">\r\n        <h4>\uD83D\uDCCA {dashboard.get('name', 'Sans nom')} {badge_html}</h4>\r\n        <p>\uD83D\uDCC5 Créé le: {created}</p>\r\n        <p>\uD83D\uDCCA {item_count} éléments</p>\r\n        <p><strong>\uD83D\uDC64 {owner_name}</strong></p>\r\n    </div>\r\n    \"\"\", unsafe_allow_html=True)\r\n\r\n    if st.button(\"Ouvrir\", key=f\"open_{dashboard['id']}_{idx}\", use_container_width=True):\r\n        with st.spinner(\"Chargement du dashboard...\"):\r\n            details = st.session_state.client.get_dashboard_details(dashboard['id'])\r\n            if details:\r\n                # Ajouter l'information du propriétaire aux détails\r\n                details['is_owner'] = is_owner\r\n                details['owner_info'] = owner_info\r\n                st.session_state.current_dashboard = details\r\n                st.rerun()\r\n\r\n\r\ndef display_selected_dashboard():\r\n    \"\"\"Affiche le dashboard sélectionné\"\"\"\r\n    dashboard = st.session_state.current_dashboard\r\n\r\n    # En-tête du dashboard\r\n    col1, col2, col3 = st.columns([3, 1, 1])\r\n    with col1:\r\n        st.markdown(f\"## \uD83D\uDCCA {dashboard.get('name', 'Dashboard')}\")\r\n        if dashboard.get('description'):\r\n            st.markdown(f\"*{dashboard.get('description')}*\")\r\n\r\n        # Afficher les informations du propriétaire\r\n        owner_info = dashboard.get('owner_info', {})\r\n        is_owner = dashboard.get('is_owner', False)\r\n\r\n        if is_owner:\r\n            st.markdown(\"**\uD83D\uDC64 Vous êtes le propriétaire**\")\r\n        elif owner_info:\r\n            st.markdown(f\"**\uD83D\uDC64 Propriétaire: {owner_info.get('name', 'Inconnu')}**\")\r\n\r\n    with col2:\r\n        st.metric(\"Éléments\", len(dashboard.get('dashboardItems', [])))\r\n    with col3:\r\n        if st.button(\"← Retour\", key=\"back_btn\", use_container_width=True):\r\n            st.session_state.current_dashboard = None\r\n            st.rerun()\r\n\r\n    # Éléments du dashboard\r\n    items = dashboard.get('dashboardItems', [])\r\n\r\n    if items:\r\n        st.markdown(\"---\")\r\n        st.markdown(f\"### \uD83D\uDCCB Éléments du Dashboard ({len(items)})\")\r\n\r\n        # Export global (autorisé pour tous les dashboards)\r\n        if st.button(\"\uD83D\uDCE6 Exporter tout le dashboard\", type=\"primary\", key=\"export_all\"):\r\n            export_all_dashboard_data(items, dashboard)\r\n\r\n        st.markdown(\"---\")\r\n\r\n        # Afficher chaque élément\r\n        for idx, item in enumerate(items):\r\n            display_dashboard_item(item, idx)\r\n    else:\r\n        st.info(\"Ce dashboard ne contient aucun élément.\")\r\n\r\n\r\ndef export_all_dashboard_data(items, dashboard):\r\n    \"\"\"Exporte toutes les données du dashboard\"\"\"\r\n    all_data = {}\r\n\r\n    progress_bar = st.progress(0)\r\n    status_text = st.empty()\r\n\r\n    for idx, item in enumerate(items):\r\n        status_text.text(f\"Export de l'élément {idx + 1}/{len(items)}...\")\r\n        data, info, item_type = st.session_state.client.get_item_data(item)\r\n\r\n        if not data.empty:\r\n            item_name = get_item_name(item, idx)\r\n            all_data[item_name] = data\r\n\r\n        progress_bar.progress((idx + 1) / len(items))\r\n\r\n    if all_data:\r\n        create_global_export(all_data, dashboard)\r\n    else:\r\n        st.warning(\"Aucune donnée à exporter\")\r\n\r\n    progress_bar.empty()\r\n    status_text.empty()\r\n\r\n\r\ndef get_item_name(item, idx):\r\n    \"\"\"Récupère le nom d'un élément\"\"\"\r\n    if 'visualization' in item and item['visualization']:\r\n        return item['visualization'].get('name', f'Viz_{idx}')\r\n    elif 'chart' in item and item['chart']:\r\n        return item['chart'].get('name', f'Chart_{idx}')\r\n    elif 'map' in item and item['map']:\r\n        return item['map'].get('name', f'Carte_{idx}')\r\n    elif 'text' in item:\r\n        return f\"Texte_{idx}\"\r\n    return f\"Élément_{idx}\"\r\n\r\n\r\ndef create_global_export(all_data, dashboard):\r\n    \"\"\"Crée un export global de toutes les données\"\"\"\r\n    try:\r\n        output = io.BytesIO()\r\n\r\n        with pd.ExcelWriter(output, engine='openpyxl') as writer:\r\n            # Feuille de sommaire\r\n            summary = []\r\n            for name, df in all_data.items():\r\n                summary.append({\r\n                    'Nom': name,\r\n                    'Lignes': len(df),\r\n                    'Colonnes': len(df.columns),\r\n                    'Date export': datetime.now().strftime('%Y-%m-%d %H:%M')\r\n                })\r\n\r\n            pd.DataFrame(summary).to_excel(writer, sheet_name='Sommaire', index=False)\r\n\r\n            # Données\r\n            for name, df in all_data.items():\r\n                safe_name = name[:31]\r\n                df.to_excel(writer, sheet_name=safe_name, index=False)\r\n\r\n        excel_data = output.getvalue()\r\n\r\n        st.download_button(\r\n            label=\"\uD83D\uDCE5 Télécharger le fichier Excel complet\",\r\n            data=excel_data,\r\n            file_name=f\"{dashboard.get('name', 'dashboard').replace(' ', '_')}_complet.xlsx\",\r\n            mime=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n            key=f\"download_all_{int(time.time())}\"\r\n        )\r\n    except Exception as e:\r\n        st.error(f\"Erreur lors de la création du fichier Excel: {str(e)}\")\r\n\r\n\r\ndef display_dashboard_item(item, idx):\r\n    \"\"\"Affiche un élément du dashboard\"\"\"\r\n    st.markdown(f\"#### \uD83D\uDCCB Élément {idx + 1}\")\r\n\r\n    # Récupérer les données\r\n    data, info, item_type = st.session_state.client.get_item_data(item)\r\n\r\n    # Nom de l'élément\r\n    item_name = get_item_name(item, idx)\r\n\r\n    # Afficher les données\r\n    if not data.empty:\r\n        display_visualization_with_charts(data, item_name, info, item_type)\r\n    else:\r\n        st.warning(f\"⚠\uFE0F Aucune donnée disponible pour {item_name}\")\r\n\r\n    st.markdown(\"---\")\r\n\r\n\r\ndef display_welcome_page():\r\n    \"\"\"Affiche la page d'accueil\"\"\"\r\n    col1, col2, col3 = st.columns([1, 2, 1])\r\n    with col2:\r\n        st.markdown(\"\"\"\r\n        <div style='text-align: center; padding: 40px;'>\r\n            <h2>Bienvenue sur DHIS2 Dashboard Viewer</h2>\r\n            <p>Connectez-vous pour visualiser et exporter TOUS les dashboards DHIS2 disponibles.</p>\r\n            <div style='margin-top: 30px;'>\r\n                <h4>\uD83C\uDFAF Fonctionnalités principales:</h4>\r\n                <div style='text-align: left; margin: 20px;'>\r\n                    <p>✅ <strong>Tous les dashboards:</strong> Accès complet à tous les dashboards disponibles</p>\r\n                    <p>✅ <strong>Vue complète:</strong> Tous les dashboards affichés en une seule page</p>\r\n                    <p>✅ <strong>Recherche:</strong> Trouvez rapidement les dashboards par nom</p>\r\n                    <p>✅ <strong>Graphiques interactifs:</strong> Barres, lignes, circulaires, cartes</p>\r\n                    <p>✅ <strong>Analyses statistiques:</strong> Statistiques descriptives, distributions</p>\r\n                    <p>✅ <strong>Export multiple:</strong> Excel, CSV, JSON</p>\r\n                    <p>✅ <strong>Visualisation cartographique:</strong> Carte choroplèthe</p>\r\n                    <p>✅ <strong>Données réalistes:</strong> Vaccination, paludisme, nutrition, etc.</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \"\"\", unsafe_allow_html=True)\r\n\r\n\r\ndef display_all_dashboards():\r\n    \"\"\"Affiche TOUS les dashboards disponibles en une seule page\"\"\"\r\n    st.markdown(\"### \uD83D\uDCCB Tous les Dashboards Disponibles\")\r\n\r\n    # Barre de recherche et statistiques\r\n    st.markdown('<div class=\"search-box\">', unsafe_allow_html=True)\r\n    col1, col2, col3, col4 = st.columns([3, 1, 1, 1])\r\n\r\n    with col1:\r\n        search_query = st.text_input(\r\n            \"\uD83D\uDD0D Rechercher un dashboard par nom\",\r\n            placeholder=\"Entrez le nom du dashboard...\",\r\n            key=\"dashboard_search\"\r\n        )\r\n\r\n    st.markdown('</div>', unsafe_allow_html=True)\r\n\r\n    # Charger tous les dashboards\r\n    if 'all_dashboards_complete' not in st.session_state:\r\n        st.session_state.all_dashboards_complete = []\r\n        st.session_state.last_search_query = \"\"\r\n\r\n    # Vérifier si on doit recharger les données\r\n    current_search = search_query if search_query else \"\"\r\n    if (not st.session_state.all_dashboards_complete or\r\n            st.session_state.last_search_query != current_search):\r\n        with st.spinner(\"Chargement de tous les dashboards...\"):\r\n            dashboards = st.session_state.client.get_all_dashboards_complete(\r\n                search_query=search_query if search_query else None\r\n            )\r\n            st.session_state.all_dashboards_complete = dashboards\r\n            st.session_state.last_search_query = current_search\r\n\r\n    dashboards = st.session_state.all_dashboards_complete\r\n\r\n    if not dashboards:\r\n        if search_query:\r\n            st.info(f\"Aucun dashboard trouvé pour la recherche: '{search_query}'\")\r\n        else:\r\n            st.info(\"Aucun dashboard disponible.\")\r\n    else:\r\n        # Afficher les statistiques\r\n        owner_count = sum(1 for d in dashboards if d.get('is_owner'))\r\n        others_count = len(dashboards) - owner_count\r\n\r\n        col1, col2, col3 = st.columns(3)\r\n        with col1:\r\n            st.metric(\"Total dashboards\", len(dashboards))\r\n        with col2:\r\n            st.metric(\"Vos dashboards\", owner_count)\r\n        with col3:\r\n            st.metric(\"Autres dashboards\", others_count)\r\n\r\n        if search_query:\r\n            st.success(f\"\uD83D\uDD0D {len(dashboards)} dashboard(s) trouvé(s) pour la recherche\")\r\n\r\n        # Conteneur défilable pour tous les dashboards\r\n        st.markdown(f'<div class=\"scrollable-container\">', unsafe_allow_html=True)\r\n\r\n        # Grille de dashboards avec 3 colonnes\r\n        cols = st.columns(3)\r\n        for idx, dashboard in enumerate(dashboards):\r\n            with cols[idx % 3]:\r\n                display_dashboard_card(dashboard, idx)\r\n\r\n        st.markdown('</div>', unsafe_allow_html=True)\r\n\r\n        # Options d'export global\r\n        st.markdown(\"---\")\r\n        col1, col2 = st.columns(2)\r\n        with col1:\r\n            if st.button(\"\uD83D\uDCE5 Exporter la liste des dashboards\", use_container_width=True):\r\n                export_dashboards_list(dashboards)\r\n        with col2:\r\n            if st.button(\"\uD83D\uDD04 Actualiser tous les dashboards\", use_container_width=True):\r\n                st.session_state.all_dashboards_complete = []\r\n                st.rerun()\r\n\r\n\r\ndef export_dashboards_list(dashboards):\r\n    \"\"\"Exporte la liste complète des dashboards\"\"\"\r\n    try:\r\n        # Créer un DataFrame avec la liste des dashboards\r\n        data = []\r\n        for dashboard in dashboards:\r\n            owner_info = dashboard.get('user', {})\r\n            data.append({\r\n                'Nom': dashboard.get('name', ''),\r\n                'ID': dashboard.get('id', ''),\r\n                'Propriétaire': owner_info.get('name', ''),\r\n                'Éléments': len(dashboard.get('dashboardItems', [])),\r\n                'Créé le': dashboard.get('created', '')[:10] if dashboard.get('created') else '',\r\n                'Modifié le': dashboard.get('lastUpdated', '')[:10] if dashboard.get('lastUpdated') else '',\r\n                'Description': dashboard.get('description', '')[:100] + \"...\" if len(\r\n                    dashboard.get('description', '')) > 100 else dashboard.get('description', ''),\r\n                'Votre dashboard': 'Oui' if dashboard.get('is_owner') else 'Non'\r\n            })\r\n\r\n        df = pd.DataFrame(data)\r\n\r\n        # Créer le fichier Excel\r\n        output = io.BytesIO()\r\n        with pd.ExcelWriter(output, engine='openpyxl') as writer:\r\n            df.to_excel(writer, sheet_name='Liste des Dashboards', index=False)\r\n\r\n            # Ajouter une feuille de statistiques\r\n            stats_df = pd.DataFrame({\r\n                'Statistique': ['Total dashboards', 'Vos dashboards', 'Autres dashboards',\r\n                                'Moyenne éléments/dashboard'],\r\n                'Valeur': [\r\n                    len(dashboards),\r\n                    sum(1 for d in dashboards if d.get('is_owner')),\r\n                    len(dashboards) - sum(1 for d in dashboards if d.get('is_owner')),\r\n                    round(np.mean([len(d.get('dashboardItems', [])) for d in dashboards]), 2)\r\n                ]\r\n            })\r\n            stats_df.to_excel(writer, sheet_name='Statistiques', index=False)\r\n\r\n        excel_data = output.getvalue()\r\n\r\n        # Télécharger\r\n        st.download_button(\r\n            label=\"\uD83D\uDCE5 Télécharger la liste complète\",\r\n            data=excel_data,\r\n            file_name=f\"liste_dashboards_complete_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx\",\r\n            mime=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n            key=f\"download_list_{int(time.time())}\"\r\n        )\r\n    except Exception as e:\r\n        st.error(f\"Erreur lors de la création du fichier: {str(e)}\")\r\n\r\n\r\ndef main():\r\n    # En-tête\r\n    st.markdown('<h1 class=\"main-header\">\uD83D\uDCCA DHIS2 Dashboard Viewer</h1>', unsafe_allow_html=True)\r\n\r\n    # Initialisation session state\r\n    if 'authenticated' not in st.session_state:\r\n        st.session_state.authenticated = False\r\n    if 'client' not in st.session_state:\r\n        st.session_state.client = None\r\n    if 'current_dashboard' not in st.session_state:\r\n        st.session_state.current_dashboard = None\r\n    if 'user_info' not in st.session_state:\r\n        st.session_state.user_info = None\r\n    if 'search_query' not in st.session_state:\r\n        st.session_state.search_query = ''\r\n\r\n    # Sidebar\r\n    with st.sidebar:\r\n        st.markdown(\"### \uD83D\uDD10 Connexion DHIS2\")\r\n\r\n        base_url = st.text_input(\r\n            \"URL DHIS2\",\r\n            value=\"https://senegal.dhis2.org/dhis\",\r\n            key=\"base_url\"\r\n        )\r\n\r\n        username = st.text_input(\"Nom d'utilisateur\", key=\"username\")\r\n        password = st.text_input(\"Mot de passe\", type=\"password\", key=\"password\")\r\n\r\n        col1, col2 = st.columns(2)\r\n        with col1:\r\n            if st.button(\"Se connecter\", key=\"login_btn\", use_container_width=True):\r\n                with st.spinner(\"Connexion...\"):\r\n                    client = DHIS2Client(base_url, username, password)\r\n                    success, user_info = client.test_connection()\r\n\r\n                    if success:\r\n                        st.session_state.authenticated = True\r\n                        st.session_state.client = client\r\n                        st.session_state.user_info = user_info\r\n\r\n                        # Réinitialiser les données\r\n                        st.session_state.all_dashboards_complete = []\r\n                        st.session_state.last_search_query = ''\r\n                        st.session_state.search_query = ''\r\n\r\n                        st.success(f\"✅ Connecté: {user_info.get('name', username)}\")\r\n                        st.rerun()\r\n                    else:\r\n                        st.error(\"❌ Échec de connexion\")\r\n\r\n        with col2:\r\n            if st.button(\"Déconnexion\", key=\"logout_btn\", use_container_width=True):\r\n                for key in list(st.session_state.keys()):\r\n                    del st.session_state[key]\r\n                st.session_state.authenticated = False\r\n                st.session_state.search_query = ''\r\n                st.rerun()\r\n\r\n        if st.session_state.authenticated and st.session_state.user_info:\r\n            st.markdown(\"---\")\r\n            user = st.session_state.user_info\r\n            st.markdown(f\"**\uD83D\uDC64 {user.get('name')}**\")\r\n            st.markdown(f\"*{user.get('email', '')}*\")\r\n\r\n            st.markdown(\"---\")\r\n\r\n            # Options\r\n            st.markdown(\"### ⚙\uFE0F Options\")\r\n            if st.button(\"\uD83D\uDD04 Actualiser les dashboards\", use_container_width=True):\r\n                st.session_state.all_dashboards_complete = []\r\n                st.rerun()\r\n\r\n    # Contenu principal\r\n    if not st.session_state.authenticated:\r\n        display_welcome_page()\r\n    else:\r\n        # Dashboard sélectionné\r\n        if st.session_state.current_dashboard:\r\n            display_selected_dashboard()\r\n        else:\r\n            # Afficher directement tous les dashboards\r\n            display_all_dashboards()\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/main.py b/main.py
--- a/main.py	(revision 086c3e94b16cb0d376821df690a293901a0e1697)
+++ b/main.py	(date 1765072925470)
@@ -3,12 +3,16 @@
 import pandas as pd
 import numpy as np
 import json
-from datetime import datetime
-
+from datetime import datetime, timedelta
+import plotly.graph_objects as go
+import base64
 import plotly.express as px
 import io
 import time
-
+import openpyxl
+import csv
+import matplotlib.pyplot as plt
+import seaborn as sns
 
 # Configuration de la page
 st.set_page_config(
Index: .idea/workspace.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"AutoImportSettings\">\r\n    <option name=\"autoReloadType\" value=\"SELECTIVE\" />\r\n  </component>\r\n  <component name=\"ChangeListManager\">\r\n    <list default=\"true\" id=\"ae945e91-26f8-4147-b00c-46028194e2ca\" name=\"Changes\" comment=\"1 commit\" />\r\n    <option name=\"SHOW_DIALOG\" value=\"false\" />\r\n    <option name=\"HIGHLIGHT_CONFLICTS\" value=\"true\" />\r\n    <option name=\"HIGHLIGHT_NON_ACTIVE_CHANGELIST\" value=\"false\" />\r\n    <option name=\"LAST_RESOLUTION\" value=\"IGNORE\" />\r\n  </component>\r\n  <component name=\"Git.Settings\">\r\n    <option name=\"RECENT_GIT_ROOT_PATH\" value=\"$PROJECT_DIR$\" />\r\n  </component>\r\n  <component name=\"GitHubPullRequestSearchHistory\"><![CDATA[{\r\n  \"lastFilter\": {\r\n    \"state\": \"OPEN\",\r\n    \"assignee\": \"khadidiatousa\"\r\n  }\r\n}]]></component>\r\n  <component name=\"GithubPullRequestsUISettings\"><![CDATA[{\r\n  \"selectedUrlAndAccountId\": {\r\n    \"url\": \"https://github.com/khadidiatousa/DashboardDHIS2.git\",\r\n    \"accountId\": \"0075b63c-ed26-4a89-9c70-388d99255f5c\"\r\n  }\r\n}]]></component>\r\n  <component name=\"ProjectColorInfo\">{\r\n  &quot;associatedIndex&quot;: 8\r\n}</component>\r\n  <component name=\"ProjectId\" id=\"36R4wOiyuUR9VijaktIwQgI1NVp\" />\r\n  <component name=\"ProjectViewState\">\r\n    <option name=\"hideEmptyMiddlePackages\" value=\"true\" />\r\n    <option name=\"showLibraryContents\" value=\"true\" />\r\n  </component>\r\n  <component name=\"PropertiesComponent\">{\r\n  &quot;keyToString&quot;: {\r\n    &quot;ModuleVcsDetector.initialDetectionPerformed&quot;: &quot;true&quot;,\r\n    &quot;RunOnceActivity.ShowReadmeOnStart&quot;: &quot;true&quot;,\r\n    &quot;RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252&quot;: &quot;true&quot;,\r\n    &quot;git-widget-placeholder&quot;: &quot;master&quot;\r\n  }\r\n}</component>\r\n  <component name=\"SharedIndexes\">\r\n    <attachedChunks>\r\n      <set>\r\n        <option value=\"bundled-python-sdk-4e2b1448bda8-9a97661f3031-com.jetbrains.pycharm.pro.sharedIndexes.bundled-PY-252.27397.106\" />\r\n      </set>\r\n    </attachedChunks>\r\n  </component>\r\n  <component name=\"TaskManager\">\r\n    <task active=\"true\" id=\"Default\" summary=\"Default task\">\r\n      <changelist id=\"ae945e91-26f8-4147-b00c-46028194e2ca\" name=\"Changes\" comment=\"\" />\r\n      <created>1764956287343</created>\r\n      <option name=\"number\" value=\"Default\" />\r\n      <option name=\"presentableId\" value=\"Default\" />\r\n      <updated>1764956287343</updated>\r\n    </task>\r\n    <task id=\"LOCAL-00001\" summary=\"1 commit\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1765070163668</created>\r\n      <option name=\"number\" value=\"00001\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-00001\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1765070163668</updated>\r\n    </task>\r\n    <task id=\"LOCAL-00002\" summary=\"1 commit\">\r\n      <option name=\"closed\" value=\"true\" />\r\n      <created>1765071534744</created>\r\n      <option name=\"number\" value=\"00002\" />\r\n      <option name=\"presentableId\" value=\"LOCAL-00002\" />\r\n      <option name=\"project\" value=\"LOCAL\" />\r\n      <updated>1765071534744</updated>\r\n    </task>\r\n    <option name=\"localTasksCounter\" value=\"3\" />\r\n    <servers />\r\n  </component>\r\n  <component name=\"VcsManagerConfiguration\">\r\n    <MESSAGE value=\"1 commit\" />\r\n    <option name=\"LAST_COMMIT_MESSAGE\" value=\"1 commit\" />\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.idea/workspace.xml b/.idea/workspace.xml
--- a/.idea/workspace.xml	(revision 086c3e94b16cb0d376821df690a293901a0e1697)
+++ b/.idea/workspace.xml	(date 1765072644213)
@@ -4,13 +4,22 @@
     <option name="autoReloadType" value="SELECTIVE" />
   </component>
   <component name="ChangeListManager">
-    <list default="true" id="ae945e91-26f8-4147-b00c-46028194e2ca" name="Changes" comment="1 commit" />
+    <list default="true" id="ae945e91-26f8-4147-b00c-46028194e2ca" name="Changes" comment="1 commit">
+      <change beforePath="$PROJECT_DIR$/.idea/workspace.xml" beforeDir="false" afterPath="$PROJECT_DIR$/.idea/workspace.xml" afterDir="false" />
+      <change beforePath="$PROJECT_DIR$/main.py" beforeDir="false" afterPath="$PROJECT_DIR$/main.py" afterDir="false" />
+    </list>
     <option name="SHOW_DIALOG" value="false" />
     <option name="HIGHLIGHT_CONFLICTS" value="true" />
     <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
     <option name="LAST_RESOLUTION" value="IGNORE" />
   </component>
   <component name="Git.Settings">
+    <option name="PUSH_TAGS">
+      <GitPushTagMode>
+        <option name="argument" value="--tags" />
+        <option name="title" value="All" />
+      </GitPushTagMode>
+    </option>
     <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$" />
   </component>
   <component name="GitHubPullRequestSearchHistory"><![CDATA[{
@@ -72,7 +81,23 @@
       <option name="project" value="LOCAL" />
       <updated>1765071534744</updated>
     </task>
-    <option name="localTasksCounter" value="3" />
+    <task id="LOCAL-00003" summary="1 commit">
+      <option name="closed" value="true" />
+      <created>1765071949763</created>
+      <option name="number" value="00003" />
+      <option name="presentableId" value="LOCAL-00003" />
+      <option name="project" value="LOCAL" />
+      <updated>1765071949763</updated>
+    </task>
+    <task id="LOCAL-00004" summary="1 commit">
+      <option name="closed" value="true" />
+      <created>1765072027630</created>
+      <option name="number" value="00004" />
+      <option name="presentableId" value="LOCAL-00004" />
+      <option name="project" value="LOCAL" />
+      <updated>1765072027630</updated>
+    </task>
+    <option name="localTasksCounter" value="5" />
     <servers />
   </component>
   <component name="VcsManagerConfiguration">
